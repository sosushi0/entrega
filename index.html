<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Red - NAISATA SOLUCIONES</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 1);
        }
        
        .active-project {
            background-color: rgb(37 99 235);
            color: white;
        }

        #signature-canvas {
            touch-action: none;
            cursor: crosshair;
        }

        /* Estilos para el scroll lateral de la tabla en móvil */
        .table-container::-webkit-scrollbar {
            height: 4px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 flex flex-col md:flex-row">

    <!-- Mobile Header -->
    <div class="md:hidden bg-white border-b border-slate-200 p-4 flex justify-between items-center sticky top-0 z-40">
        <div class="flex items-center gap-2">
            <h2 class="text-lg font-black text-blue-600 tracking-tighter">NAISATA</h2>
        </div>
        <button onclick="toggleSidebar()" class="p-2 text-slate-600">
            <i data-lucide="menu"></i>
        </button>
    </div>

    <!-- Sidebar / Navigation -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-white border-r border-slate-200 flex flex-col shrink-0 -translate-x-full md:translate-x-0 transition-transform duration-300 md:relative">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
            <div class="text-center w-full">
                <div id="sidebarLogoContainer" class="mb-2 hidden">
                    <img id="sidebarLogoPreview" src="" alt="Logo" class="max-h-12 mx-auto object-contain">
                </div>
                <h2 id="companyTitle" class="text-xl font-black text-blue-600 tracking-tighter leading-tight">NAISATA <br> SOLUCIONES</h2>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Sistemas & Redes</p>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden p-1 text-slate-400">
                <i data-lucide="x"></i>
            </button>
        </div>
        
        <div class="p-4 flex-1 overflow-y-auto">
            <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 px-2">Proyectos</h3>
            <div id="projectList" class="space-y-1">
                <!-- Proyectos se cargan aquí -->
            </div>
            
            <button onclick="openProjectModal()" class="w-full mt-4 flex items-center gap-2 px-4 py-2 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition border border-dashed border-blue-200">
                <i data-lucide="plus" class="w-4 h-4"></i> Nuevo Proyecto
            </button>

            <div class="mt-8 border-t border-slate-100 pt-6">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 px-2">Ajustes</h3>
                <input type="file" id="logoInput" accept="image/*" class="hidden" onchange="handleLogoUpload(event)">
                <button onclick="document.getElementById('logoInput').click()" class="w-full flex items-center gap-2 px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50 rounded-lg transition">
                    <i data-lucide="image" class="w-4 h-4"></i> Cambiar Logo
                </button>
                <button id="btnRemoveLogo" onclick="removeLogo()" class="hidden w-full flex items-center gap-2 px-4 py-2 text-sm font-medium text-red-500 hover:bg-red-50 rounded-lg transition mt-1">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Quitar Logo
                </button>
            </div>
        </div>

        <div class="p-4 border-t border-slate-100 bg-slate-50/50 space-y-2">
            <input type="file" id="importInput" accept=".json" class="hidden" onchange="importData(event)">
            <button onclick="document.getElementById('importInput').click()" class="w-full flex items-center gap-2 px-3 py-2 text-xs font-semibold text-slate-600 hover:bg-white border border-transparent hover:border-slate-200 rounded-lg transition">
                <i data-lucide="upload" class="w-4 h-4"></i> Importar JSON
            </button>
            <button onclick="exportData()" class="w-full flex items-center gap-2 px-3 py-2 text-xs font-semibold text-slate-600 hover:bg-white border border-transparent hover:border-slate-200 rounded-lg transition">
                <i data-lucide="download" class="w-4 h-4"></i> Backup
            </button>
        </div>
    </aside>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 hidden md:hidden"></div>

    <!-- Main Content -->
    <main class="flex-1 max-h-screen overflow-y-auto p-4 md:p-8">
        <div class="max-w-5xl mx-auto">
            <!-- Header -->
            <header class="mb-8 flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase">Proyecto Actual</span>
                    </div>
                    <h1 id="currentProjectTitle" class="text-3xl md:text-4xl font-extrabold text-slate-900 uppercase tracking-tight">Cargando...</h1>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="openSignatureModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 rounded-xl transition flex items-center gap-2 shadow-lg font-bold text-sm grow md:grow-0 justify-center">
                        <i data-lucide="pen-tool" class="w-4 h-4"></i> Firmar
                    </button>
                    <button onclick="generateDeliveryPDF()" class="bg-slate-900 hover:bg-black text-white px-4 py-2.5 rounded-xl transition flex items-center gap-2 shadow-lg font-bold text-sm grow md:grow-0 justify-center">
                        <i data-lucide="printer" class="w-4 h-4"></i> Imprimir PDF
                    </button>
                    <button onclick="toggleDeviceModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl transition flex items-center gap-2 shadow-lg shadow-blue-200 font-bold text-sm grow md:grow-0 justify-center">
                        <i data-lucide="plus" class="w-4 h-4"></i> Agregar
                    </button>
                </div>
            </header>

            <!-- Search Bar -->
            <div class="mb-6 relative">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                <input type="text" id="searchInput" placeholder="Filtrar por nombre o IP..." 
                    class="w-full pl-12 pr-4 py-4 rounded-2xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:outline-none transition shadow-sm bg-white"
                    onkeyup="filterTable()">
            </div>

            <!-- Table Container -->
            <div class="glass-card rounded-2xl shadow-sm overflow-hidden border border-slate-200">
                <div class="table-container overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[600px]">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-200">
                                <th class="px-6 py-4 text-[11px] font-black uppercase text-slate-400 tracking-widest">Dispositivo</th>
                                <th class="px-6 py-4 text-[11px] font-black uppercase text-slate-400 tracking-widest">Dirección IP</th>
                                <th class="px-6 py-4 text-[11px] font-black uppercase text-slate-400 tracking-widest">Acceso</th>
                                <th class="px-6 py-4 text-[11px] font-black uppercase text-slate-400 tracking-widest">Contraseña</th>
                                <th class="px-6 py-4 text-[11px] font-black uppercase text-slate-400 tracking-widest text-right">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="deviceTableBody" class="divide-y divide-slate-100 bg-white">
                            <!-- Data populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div id="emptyState" class="hidden p-20 text-center">
                    <div class="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="database" class="w-8 h-8 text-slate-300"></i>
                    </div>
                    <p class="text-slate-400 font-medium">No hay equipos en este proyecto.</p>
                </div>
            </div>

            <!-- Signature Display (Footer) -->
            <div id="signaturePreviewContainer" class="hidden mt-8 p-6 glass-card rounded-2xl border-dashed border-2 border-slate-200 flex flex-col items-center">
                <h4 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest">Firma Registrada para PDF</h4>
                <img id="signaturePreviewImage" src="" alt="Firma" class="max-h-24 bg-white p-2 rounded border border-slate-100">
                <button onclick="clearStoredSignature()" class="mt-4 text-xs font-bold text-red-500 hover:text-red-600 flex items-center gap-1">
                    <i data-lucide="trash-2" class="w-3 h-3"></i> Eliminar firma
                </button>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Project Modal -->
    <div id="projectModal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center p-4 z-[100] backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 scale-animation">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Nuevo Proyecto</h3>
            <input type="text" id="projectPathInput" placeholder="Nombre (ej: Residencial X)" class="w-full p-4 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:outline-none mb-4 font-bold uppercase">
            <div class="flex gap-2">
                <button onclick="closeProjectModal()" class="flex-1 px-4 py-2 border border-slate-200 rounded-xl hover:bg-slate-50 transition font-medium">Cancelar</button>
                <button onclick="createProject()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-xl font-bold hover:bg-blue-700 transition">Crear</button>
            </div>
        </div>
    </div>

    <!-- Device Modal -->
    <div id="deviceModal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center p-4 z-[90] backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800">Agregar Equipo</h3>
                <button onclick="toggleDeviceModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button>
            </div>
            <form id="deviceForm" class="space-y-4">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Nombre</label>
                    <input type="text" id="newLabel" required class="w-full p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Ej: NVR Principal">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Dirección IP</label>
                    <input type="text" id="newIp" required class="w-full p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="192.168.20.X">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Usuario</label>
                        <input type="text" id="newUser" value="admin" class="w-full p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Password</label>
                        <input type="text" id="newPass" value="BR4GG402025$" class="w-full p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Notas</label>
                    <input type="text" id="newNotes" placeholder="Ej: Hikvision MinMoe" class="w-full p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase tracking-widest hover:bg-blue-700 transition shadow-lg shadow-blue-100">Guardar Equipo</button>
            </form>
        </div>
    </div>

    <!-- Signature Modal -->
    <div id="signatureModal" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center p-4 z-[110] backdrop-blur-sm">
        <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-slate-800">Firma de Entrega</h3>
                <button onclick="closeSignatureModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button>
            </div>
            <p class="text-xs text-slate-500 mb-4">Firme en el recuadro para incluirla en el PDF.</p>
            
            <div class="bg-slate-50 border-2 border-dashed border-slate-200 rounded-2xl overflow-hidden mb-4 relative h-64">
                <canvas id="signature-canvas" class="w-full h-full bg-white"></canvas>
            </div>

            <div class="flex gap-2">
                <button onclick="clearCanvas()" class="flex-1 px-4 py-3 border border-slate-200 rounded-xl hover:bg-slate-50 transition font-bold text-sm text-slate-600 uppercase tracking-widest">Borrar</button>
                <button onclick="saveSignature()" class="flex-1 bg-emerald-600 text-white px-4 py-3 rounded-xl font-bold hover:bg-emerald-700 transition shadow-lg shadow-emerald-100 uppercase tracking-widest text-sm">Guardar Firma</button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-8 right-8 bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-2xl transition-all translate-y-20 opacity-0 pointer-events-none flex items-center gap-3 z-[120]">
        <div class="bg-blue-500 p-1 rounded-lg">
            <i data-lucide="check" id="toastIcon" class="w-4 h-4 text-white"></i>
        </div>
        <span id="toastMsg" class="font-bold text-sm tracking-tight">Acción realizada</span>
    </div>

    <script>
        const STORAGE_KEY = 'naisata_vault_responsive_v1';
        const INITIAL_PROJECT = 'BRAGGAO';
        const COMPANY_NAME = 'NAISATA SOLUCIONES';
        
        let state = {
            projects: {
                [INITIAL_PROJECT]: [
                    { label: 'Router (Gateway)', ip: '192.168.20.1', user: 'admin', pass: 'N/A', notes: 'Gateway principal' },
                    { label: 'NVR Hikvision', ip: '192.168.20.240', user: 'admin', pass: 'BR4GG402025$', notes: 'Grabador' },
                    { label: 'Terminal MinMoe 1', ip: '192.168.20.243', user: 'admin', pass: 'BR4GG402025$', notes: 'Acceso' }
                ]
            },
            currentProject: INITIAL_PROJECT,
            logo: null,
            signature: null // Almacena el base64 de la firma
        };

        // --- Signature Logic ---
        let canvas, ctx, drawing = false;

        function initCanvas() {
            canvas = document.getElementById('signature-canvas');
            ctx = canvas.getContext('2d');
            
            // Ajustar resolución del canvas
            const resize = () => {
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                ctx.strokeStyle = "#1e293b";
                ctx.lineWidth = 2.5;
                ctx.lineCap = "round";
            };
            
            resize();
            window.addEventListener('resize', resize);

            const startDrawing = (e) => {
                drawing = true;
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            };

            const draw = (e) => {
                if (!drawing) return;
                const pos = getPos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            };

            const stopDrawing = () => drawing = false;

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            window.addEventListener('mouseup', stopDrawing);
            
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e); });
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
            canvas.addEventListener('touchend', stopDrawing);
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function saveSignature() {
            // Comprobar si hay dibujo (simple chequeo de contenido)
            const blank = document.createElement('canvas');
            blank.width = canvas.width;
            blank.height = canvas.height;
            if (canvas.toDataURL() === blank.toDataURL()) {
                showToast("Firme antes de guardar", "alert-circle", "text-amber-500");
                return;
            }
            
            state.signature = canvas.toDataURL();
            saveToStorage();
            renderSignaturePreview();
            closeSignatureModal();
            showToast("Firma guardada para el acta");
        }

        function renderSignaturePreview() {
            const container = document.getElementById('signaturePreviewContainer');
            const img = document.getElementById('signaturePreviewImage');
            if (state.signature) {
                img.src = state.signature;
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function clearStoredSignature() {
            state.signature = null;
            saveToStorage();
            renderSignaturePreview();
            showToast("Firma eliminada");
        }

        // --- UI & Storage ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function loadFromStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) try { 
                state = { ...state, ...JSON.parse(saved) };
            } catch (e) {}
            renderAll();
            initCanvas();
        }

        function saveToStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

        function renderAll() {
            renderProjectList();
            renderTable();
            renderLogo();
            renderSignaturePreview();
            document.getElementById('currentProjectTitle').innerText = state.currentProject;
            lucide.createIcons();
        }

        function renderLogo() {
            const preview = document.getElementById('sidebarLogoPreview');
            const container = document.getElementById('sidebarLogoContainer');
            const title = document.getElementById('companyTitle');
            const btnRemove = document.getElementById('btnRemoveLogo');

            if (state.logo) {
                preview.src = state.logo;
                container.classList.remove('hidden');
                title.classList.add('hidden');
                btnRemove.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
                title.classList.remove('hidden');
                btnRemove.classList.add('hidden');
            }
        }

        function handleLogoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                state.logo = event.target.result;
                saveToStorage();
                renderLogo();
                showToast("Logo actualizado");
            };
            reader.readAsDataURL(file);
        }

        function removeLogo() {
            if (confirm("¿Quitar logo?")) {
                state.logo = null;
                saveToStorage();
                renderLogo();
                showToast("Logo quitado");
            }
        }

        function renderProjectList() {
            const list = document.getElementById('projectList');
            list.innerHTML = Object.keys(state.projects).map(p => `
                <div class="group flex items-center justify-between px-3 py-2.5 rounded-xl cursor-pointer transition ${p === state.currentProject ? 'active-project shadow-md shadow-blue-100' : 'text-slate-600 hover:bg-slate-50'} "
                     onclick="switchProject('${p}'); if(window.innerWidth < 768) toggleSidebar()">
                    <span class="truncate font-bold text-sm tracking-tight">${p}</span>
                    ${p !== INITIAL_PROJECT ? `<button onclick="event.stopPropagation(); deleteProject('${p}')" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500 transition"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>` : ''}
                </div>
            `).join('');
        }

        function renderTable() {
            const tbody = document.getElementById('deviceTableBody');
            const devices = state.projects[state.currentProject] || [];
            if (devices.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');
            tbody.innerHTML = devices.map((d, index) => `
                <tr class="hover:bg-blue-50/20 transition group">
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-800 text-sm truncate max-w-[150px]">${d.label}</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider truncate max-w-[150px]">${d.notes || ''}</div>
                    </td>
                    <td class="px-6 py-4">
                        <code class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-xs font-bold font-mono border border-blue-100 cursor-pointer" onclick="copyText('${d.ip}')">${d.ip}</code>
                    </td>
                    <td class="px-6 py-4 text-slate-500 font-bold text-xs uppercase">${d.user}</td>
                    <td class="px-6 py-4">
                        <span class="font-mono text-sm text-slate-700 font-medium cursor-pointer" onclick="copyText('${d.pass}')">${d.pass}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="removeDevice(${index})" class="text-slate-200 hover:text-red-500 transition"><i data-lucide="minus-circle" class="w-5 h-5"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        // --- Logic & Actions ---
        function switchProject(name) { state.currentProject = name; saveToStorage(); renderAll(); }
        
        function deleteProject(name) {
            if (confirm(`¿Eliminar proyecto "${name}"?`)) {
                delete state.projects[name];
                if (state.currentProject === name) state.currentProject = INITIAL_PROJECT;
                saveToStorage(); renderAll();
            }
        }

        function createProject() {
            const input = document.getElementById('projectPathInput');
            const name = input.value.trim().toUpperCase();
            if (!name || state.projects[name]) return;
            state.projects[name] = [];
            state.currentProject = name;
            input.value = '';
            saveToStorage(); closeProjectModal(); renderAll();
            showToast(`Proyecto ${name} creado`);
        }

        function removeDevice(index) {
            state.projects[state.currentProject].splice(index, 1);
            saveToStorage(); renderTable();
            showToast("Equipo eliminado");
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => showToast(`Copiado: ${text}`));
            const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
        }

        function filterTable() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.getElementById('deviceTableBody').getElementsByTagName('tr');
            for (let r of rows) r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
        }

        // --- Modals ---
        function toggleDeviceModal() { document.getElementById('deviceModal').classList.toggle('hidden'); document.getElementById('deviceModal').classList.toggle('flex'); }
        function openProjectModal() { document.getElementById('projectModal').classList.remove('hidden'); document.getElementById('projectModal').classList.add('flex'); }
        function closeProjectModal() { document.getElementById('projectModal').classList.add('hidden'); }
        function openSignatureModal() { document.getElementById('signatureModal').classList.remove('hidden'); document.getElementById('signatureModal').classList.add('flex'); clearCanvas(); }
        function closeSignatureModal() { document.getElementById('signatureModal').classList.add('hidden'); }

        function showToast(msg, icon = 'check', color = 'text-white') {
            const t = document.getElementById('toast');
            const ti = document.getElementById('toastIcon');
            document.getElementById('toastMsg').innerText = msg;
            ti.setAttribute('data-lucide', icon);
            lucide.createIcons();
            t.classList.remove('opacity-0', 'translate-y-20', 'pointer-events-none');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-20', 'pointer-events-none'), 2500);
        }

        // --- PDF Generation (Pro Version) ---
        function generateDeliveryPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const project = state.currentProject;
            const devices = state.projects[project] || [];
            const date = new Date().toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' });

            // 1. Header Rect
            doc.setFillColor(30, 41, 59);
            doc.rect(0, 0, 210, 45, 'F');
            doc.setTextColor(255, 255, 255);
            
            let textStartX = 15;
            if (state.logo) {
                try {
                    doc.addImage(state.logo, 'PNG', 15, 8, 30, 30, undefined, 'FAST');
                    textStartX = 55;
                } catch(e) {}
            }
            
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.text(COMPANY_NAME, textStartX, 22);
            
            doc.setFontSize(8);
            doc.text("SISTEMAS DE SEGURIDAD, REDES Y TELECOMUNICACIONES", textStartX, 30);
            
            doc.setFontSize(14);
            doc.text("ENTREGA TÉCNICA", 195, 22, { align: 'right' });
            doc.setFontSize(9);
            doc.text(`PROYECTO: ${project}`, 195, 30, { align: 'right' });

            // 2. Info
            doc.setTextColor(40, 40, 40);
            doc.setFontSize(11);
            doc.text("Entrega formal de equipamiento y configuraciones de red:", 15, 60);
            doc.text(`Fecha: ${date}`, 15, 66);

            // 3. Table
            const tableData = devices.map(d => [d.label, d.ip, d.user, d.pass, d.notes]);
            doc.autoTable({
                startY: 75,
                head: [['EQUIPO', 'DIRECCIÓN IP', 'USUARIO', 'CONTRASEÑA', 'OBSERVACIONES']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [37, 99, 235], fontSize: 9, fontStyle: 'bold' },
                styles: { fontSize: 8, cellPadding: 4 },
                columnStyles: { 1: { fontStyle: 'bold', textColor: [37, 99, 235] } }
            });

            // 4. Footer & Signature
            let finalY = doc.lastAutoTable.finalY + 25;
            
            if (finalY > 240) { doc.addPage(); finalY = 30; }

            if (state.signature) {
                // Dibujar firma encima de la línea
                doc.addImage(state.signature, 'PNG', 130, finalY - 15, 50, 20);
            }

            doc.setDrawColor(200, 200, 200);
            doc.line(20, finalY + 5, 90, finalY + 5); 
            doc.line(120, finalY + 5, 190, finalY + 5);
            
            doc.setFontSize(8);
            doc.setTextColor(120, 120, 120);
            doc.text(`ENTREGADO POR (${COMPANY_NAME})`, 55, finalY + 11, { align: 'center' });
            doc.text("RECIBIDO POR (CLIENTE)", 155, finalY + 11, { align: 'center' });

            doc.save(`Entrega_${COMPANY_NAME.replace(/\s+/g, '_')}_${project}.pdf`);
            showToast("Acta PDF generada");
        }

        // --- Data Management ---
        document.getElementById('deviceForm').onsubmit = function(e) {
            e.preventDefault();
            state.projects[state.currentProject].push({
                label: document.getElementById('newLabel').value,
                ip: document.getElementById('newIp').value,
                user: document.getElementById('newUser').value,
                pass: document.getElementById('newPass').value,
                notes: document.getElementById('newNotes').value
            });
            saveToStorage(); renderTable(); toggleDeviceModal(); this.reset();
            showToast("Equipo guardado");
        };

        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `NAISATA_Backup_${new Date().toISOString().slice(0,10)}.json`);
            link.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.projects) { 
                        state = { ...state, ...imported }; 
                        saveToStorage(); renderAll(); 
                        showToast('Backup restaurado'); 
                    }
                } catch (err) { showToast('Archivo inválido', 'x-circle', 'text-red-400'); }
            };
            reader.readAsText(file);
        }

        window.onload = loadFromStorage;
    </script>
</body>
</html>
